# 실행 가이드 (Execution Guide)

이 문서는 데카트론 코리아 AI 챗봇 프로젝트의 설정 및 실행 방법을 안내합니다.

## 1. 사전 준비 (Prerequisites)

프로젝트 실행 전에 다음 사항들을 준비해야 합니다.

### 1.1. Python 설치

* Python 3.8 이상 버전 설치를 권장합니다 (asyncio 기능 활용).
* Python 및 pip (패키지 관리자)가 시스템 경로에 설정되어 있어야 합니다.

### 1.2. 필요 라이브러리 설치

프로젝트 루트 디렉토리에서 다음 명령어를 실행하여 `requirements.txt` 파일에 명시된 모든 라이브러리를 설치합니다.

```bash
pip install -r requirements.txt
```

*주요 라이브러리: `fastapi`, `uvicorn`, `openai`, `aiohttp`, `numpy`, `faiss-cpu` (또는 `faiss-gpu`), `langchain`, `tiktoken`, `python-dotenv`, `PyYAML`, `tenacity`, `requests` 등*

### 1.3. OpenAI API 키 설정

1.  프로젝트 루트 디렉토리(`.git` 폴더가 있는 위치)에 `.env` 파일을 생성합니다.
2.  `.env` 파일 안에 다음 형식으로 OpenAI API 키를 입력합니다. (`.env.example` 파일 참조)

    ```text
    OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    ```

    * `sk-...` 부분에 실제 발급받은 OpenAI API 키를 입력합니다.
    * **.env 파일은 민감 정보를 포함하므로 Git 저장소에 커밋되지 않도록 주의하세요.** (`.gitignore` 파일에 `.env`가 포함되어 있는지 확인)

### 1.4. RAG 데이터 생성 (최초 1회 또는 데이터 업데이트 시)

챗봇이 참고할 문서들에 대한 벡터 인덱스(`index.faiss`)와 메타데이터(`doc_meta.jsonl`)를 생성해야 합니다. 프로젝트 루트 디렉토리에서 다음 명령어를 실행합니다.

```bash
python -m pipeline.rag_generator
```

* 이 작업은 `data/original/` 폴더의 `.txt` 파일들을 읽어 처리하며, OpenAI 임베딩 API를 호출하므로 시간이 소요되고 API 비용이 발생할 수 있습니다.
* 원본 문서가 추가되거나 변경될 경우 이 명령어를 다시 실행하여 인덱스를 업데이트해야 합니다.

## 2. 챗봇 서버 실행 (Running the Chatbot Server)

챗봇 API 서버를 실행하여 사용자 요청을 처리할 수 있도록 준비합니다. 개발 환경에서는 보통 `uvicorn`을 사용합니다. 프로젝트 루트 디렉토리에서 다음 명령어를 실행합니다.

```bash
uvicorn chatbot.app:app --reload --host 127.0.0.1 --port 8000 --log-level info
```

* `chatbot.app:app`: `chatbot` 패키지 내의 `app.py` 파일 안에 있는 `app` FastAPI 인스턴스를 실행하라는 의미입니다.
* `--reload`: 개발 중 코드 변경 시 서버가 자동으로 재시작되도록 합니다. (운영 환경에서는 제거)
* `--host 127.0.0.1`: 로컬 환경에서만 접속 가능하도록 설정합니다. (외부 접속 허용 시 `0.0.0.0` 사용)
* `--port 8000`: 서버가 사용할 포트 번호입니다.
* `--log-level info`: Uvicorn 서버 및 애플리케이션 로그 레벨을 설정합니다. `debug`, `info`, `warning`, `error` 중 선택할 수 있으며, `config.yaml`의 `logging.log_level` 설정과 맞추는 것이 좋습니다. (`debug`로 설정 시 더 상세한 로그 출력)

서버가 성공적으로 실행되면, 웹 브라우저에서 `http://127.0.0.1:8000` 주소로 접속하여 챗봇 UI를 확인할 수 있습니다.

## 3. 테스트 실행 (Running Tests)

자동화된 테스트를 실행하여 챗봇의 기능과 성능을 검증합니다.

**주의:** 테스트를 실행하기 전에 **반드시 챗봇 서버가 실행 중이어야 합니다.**

테스트는 `tests/test_runner.py` 스크립트를 통해 실행하며, 커맨드 라인 인자를 사용하여 실행할 테스트 종류와 세트를 선택할 수 있습니다. 프로젝트 루트 디렉토리에서 다음 형식의 명령어를 사용합니다.

```bash
python -m tests.test_runner --test-type [유형] [--set 숫자]
```

* `python -m tests.test_runner`: `tests` 패키지 내의 `test_runner.py` 모듈을 실행합니다.
* `--test-type [유형]`: 실행할 테스트 유형을 지정합니다. (필수)
    * `function`: 기능 테스트 (`tests/test_cases/functional_tests.jsonl` 사용)
    * `overall`: 전체 테스트
* `--set [숫자]`: `--test-type`이 `overall`일 경우, 실행할 전체 테스트 세트 번호를 지정합니다. (필수, 예: `--set 1`, `--set 2`)

**예시 명령어:**

* 기능 테스트 실행:
    ```bash
    python -m tests.test_runner --test-type function
    ```
* 전체 테스트 세트 1 실행:
    ```bash
    python -m tests.test_runner --test-type overall --set 1
    ```

테스트 실행 결과는 `tests/test_results/` 디렉토리에 `test_run_[유형][_set번호]_[타임스탬프].jsonl` 형식의 파일로 저장됩니다.

## 4. 설정 변경 (Changing Configuration)

챗봇의 동작 방식(사용 모델, 프롬프트, RAG 설정, 로깅 레벨 등)을 변경하려면 프로젝트 루트의 `config.yaml` 파일을 수정합니다.

* 일부 설정 변경(예: 프롬프트 문구)은 서버 재시작 없이 반영될 수 있으나, 모델 변경 등 주요 설정 변경 시에는 챗봇 서버를 재시작하는 것이 안전합니다 (`uvicorn`의 `--reload` 옵션 사용 시 자동으로 재시작될 수 있음).

## 5. 로그 확인 (Checking Logs)

챗봇 서버 실행 중 발생하는 로그 및 API 호출 기록은 `logs/` 디렉토리에서 확인할 수 있습니다.

* **콘솔 출력:** `uvicorn` 실행 터미널에서 실시간 로그를 확인할 수 있습니다 (`--log-level` 설정에 따라 상세도 조절).
* **API 호출 기록:** `logs/` 폴더 안에 `api_history.txt.YYYYMMDD` 형식의 파일로 매일 분리되어 저장됩니다. (예: `api_history.txt.20250406`) 이 파일에는 OpenAI API 요청 및 응답 내용이 기록됩니다.